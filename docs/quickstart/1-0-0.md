# Quick Start    

## **Summary** 
SKT Container Platform은 Public Cloud에 GitOps 기반으로 Kubernetes distro를 배포/관리한다.   
본 문서는 AWS와 Github 기준으로 작성되었다.
    
SKT Container Platform은 Admin Cluster 생성과 User Cluster 생성 두 단계로 설치된다.      
   - Admin Cluster는 Bootstrap Server 구축 후, 제공되는Script를 통해 생성 된다.   
   - User Cluster는 제공되는 CLI를 통해 생성된다.   

> 본 Release는 Admin Cluster 생성 자동화는 지원하지 않는다.   
> Quickstart는 편의를 위해 제공되는 Bootstrap script 를 활용한다.

![bootstrap](../assets/images/tks-intall-step.png)


## **Prerequsition**
- **Bootstrap Server**    
   HW: AWS EC2 instance 기준 t2.medium, 10GB (GP3)   
   OS: Ubuntu 20.04     
- ** SSH PEM Key**   
  Bastion node SSH PEM key (ex. quickstart)
- **AWS Account**   
  AWS policy : [tks-capa.json](../assets/files/tks-capa.json), [tks-node.json](../assets/files/tks-node.json), [tks-ec2.json](../assets/files/tks-ec2.json), [tks-s3.json](../assets/files/tks-s3.json)   
  AWS ACCESS KEY ID, AWS ACCESS KEY  , 위 AWS policy 적용   
  AWS에 quickstart등록
- **Github Account**   
  Github Token
  User or Organization name (ex. github.com/demo-decapod10  [[참고: Decapod10]](https://futurama.fandom.com/wiki/Decapod_10))

## **Create Admin Cluster**
> Bootstrap Server에서 Admin Cluster bootstrap 절차 실시   


- pem file 생성  
```bash
$ cd ~
$ vi quickstart
$ chmod 400 quickstart
```
- bootstrap script 실행
```bash
$ cd ~
$ curl -L https://github.com/openinfradev/tks-mgmt-cluster-deploy/releases/download/v2.0.0-rc2/install-admin.sh -o quickstart.sh
$ chmod +x quickstart.sh
$ ./quickstart.sh
넘겨받은 파일 - /home/ubuntu/ - 이 없어요..
ssh key는 aws의 해당 지점에 준비되어야 하며 key 파일도 로컬에 준비되어야 합니다.
aws에서 생성한 ssh key 파일을 입력하세요.(type q to exit) : quickstart
...
...
=== Finished. Check the status of all cluster API resources in the admin cluster and use the bastion host: 999.999.999.999 ===
```
## **Post-install Admin Cluster**
> Admin Cluster의 bastion host에서 Admin Cluster에 TKS Service 설치 및 사용을 위핸 CLI tool 설치   


- Admin Cluster에 필요Tool 설치: kubectl, helm, tksadmin
```bash
$ cd ~

$ curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
$ sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
$ mkdir ~/.kube
$ cp ~/tks-mgmt-cluster-deploy/ kubeconfig_{ex.tks-admin-quickstart} ~/.kube/config

$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh

$ curl -LO https://github.com/openinfradev/tksadmin-client/releases/download/v2.0.0-rc2/tksadmin-client_2.0.0-rc2_Linux_x86_64.tar.gz
$ tar xvzf tksadmin-client_2.0.0-rc2_Linux_x86_64.tar.gz tksadmin
$ sudo install -o root -g root -m 0755 tksadmin /usr/local/bin/tksadmin

```
- Admin Cluster를 argocd 에 등록
```bash
$ ARGOCD_SERVER=$(kubectl get node | grep -v NAME | head -n 1 | cut -d' ' -f1)
$ ARGOCD_PORT=$(kubectl get svc -n argo argo-cd-argocd-server -o=jsonpath='{.spec.ports[0].nodePort}')
$ ARGOCD_PASSWD=$(kubectl -n argo get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
$ CURRENT_CONTEXT=$(kubectl config current-context)
$ argocd login --plaintext $ARGOCD_SERVER:$ARGOCD_PORT --username admin --password $ARGOCD_PASSWD
$ argocd cluster add $CURRENT_CONTEXT --name tks-admin -y
```

- Admin Cluster에 TKS Service 설치
```bash
$ kubectl create ns tks
$ helm repo add tks https://openinfradev.github.io/helm-repo
$ helm repo update
$ helm install tks-info tks/tks-info -n tks
$ helm install tks-contract tks/tks-contract -n tks --set args.revision=release-v2
$ helm install tks-cluster-lcm tks/tks-cluster-lcm -n tks --set args.gitAccount={ex.demo-decapod10}
$ helm install tks-batch tks/tks-batch -n tks

```
- Install CLI 
     - [CLI Install](../cli/install.md)   
     - [CLI Config](../cli/configuration.md)   
- CLI 동작확인
```bash
## Solution 자체는 multi-tenant 지원을 전제로 개발됨. contract가 tenant를 의미함. 편의를 위해 default contract 생성기능 사용
$ tksadmin contract create default
Using config file: /home/ubuntu/.tks-client.yaml
Contract Name:  default
Proto Json data...
{
  "contractor_name": "default",
  "quota": {
    "cpu": "1200",
    "memory": "1200",
    "block": "1200"
  },
  "available_services": [
    "LMA",
    "SERVICE_MESH"
  ],
  "csp_name": "aws"
}
csp_id:"54b98dee-17b5-42df-ab16-c7bb2aafd12d" contract_id:"aede96fe-5cbe-402e-b163-27abd2511986"

$ tks cluster list
Using config file: /home/ubuntu/.tks-client.yaml
No cluster exists for specified contract!
```

## Create User Cluster

## Create Service

## Clean Up
- Delete Service
- Delete User Cluster
- Delete Admin Cluster   
> 본 Release에서는 Admin Cluster의 LCM은 제공하지 않는다.  

    - AWS 자원삭제   
      AWS 자원은 Cluster Name으로 Tagging 되어 있다.  
      자원삭제 순서 : LoadBlancer삭제 --> NAT Gateway 삭제 --> Auto-sclaing group 삭제 --> EC2 instance 삭제 --> VPC 삭제

